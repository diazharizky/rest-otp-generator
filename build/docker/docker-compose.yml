version: "3.4"
services:
  redis:
    image: redis:6.0
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 1s
      timeout: 3s
      retries: 30
    ports:
      - "6379:6379"

  test:
    image: diazharizky/golang:1.17.5-alpine
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - CONFIG_FILE_PATH=${PWD}/../../configs
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ../../:${PWD}/../..
      - ${GOPATH}/pkg:/go/pkg
    working_dir: ${PWD}/../..
    command: make test
